import{c as D,u as I,g as B,j as t,s as $,t as R,a as Q}from"./main-D_QOtJ75.js";import{u as G}from"./useUserProfile-HvptepPR.js";import{z as A,t as K,u as M,L as O}from"./label-CqcMyrRf.js";import{u as V}from"./useMutation-DYqESHb7.js";import{B as Z}from"./button-BnWcWO71.js";import{I as H}from"./input-DbyYkZn1.js";import"./useQuery-tapXCO0W.js";import"./useBaseQuery-BJjxcAKU.js";import"./index-CtIrN4Eb.js";import"./utils-CjfV1Qjd.js";const J=A.object({username:A.string().min(3,"Username must be at least 3 characters").max(20,"Username must be at most 20 characters").regex(/^[a-zA-Z0-9]+$/,"Username can only contain letters and numbers (no spaces or special characters)").transform(s=>s.toLowerCase())});function W(s){const e=D.c(38),{profile:r}=s,{user:a}=I(),j=B();let n;e[0]===Symbol.for("react.memo_cache_sentinel")?(n=K(J),e[0]=n):n=e[0];const i=r?.username||"";let l;e[1]!==i?(l={resolver:n,defaultValues:{username:i}},e[1]=i,e[2]=l):l=e[2];const{register:o,handleSubmit:U,formState:T}=M(l),{errors:w,isDirty:k}=T;let m;e[3]!==r?.username||e[4]!==a?(m=async b=>{if(!a)throw new Error("Not authenticated");if(b.username!==r?.username){const{data:z,error:q}=await $.from("profiles").select("username").eq("username",b.username.toLowerCase()).single();if(q&&q.code!=="PGRST116")throw q;if(z)throw new Error("This username is already taken")}const{error:F}=await $.from("profiles").upsert({username:b.username,updated_at:new Date().toISOString(),user_id:a.id});if(F)throw F},e[3]=r?.username,e[4]=a,e[5]=m):m=e[5];let c;e[6]!==j||e[7]!==a?.id?(c=()=>{j.invalidateQueries({queryKey:["profile",a?.id]}),R.success("Username updated successfully")},e[6]=j,e[7]=a?.id,e[8]=c):c=e[8];let S;e[9]!==m||e[10]!==c?(S={mutationFn:m,onSuccess:c,onError:X},e[9]=m,e[10]=c,e[11]=S):S=e[11];const y=V(S);let v;e[12]!==y?(v=b=>{y.mutate(b)},e[12]=y,e[13]=v):v=e[13];const E=v;let u;e[14]!==U||e[15]!==E?(u=U(E),e[14]=U,e[15]=E,e[16]=u):u=e[16];let N;e[17]===Symbol.for("react.memo_cache_sentinel")?(N=t.jsx(O,{htmlFor:"username",children:"Username"}),e[17]=N):N=e[17];let f;e[18]!==o?(f=o("username"),e[18]=o,e[19]=f):f=e[19];const L=w.username?"border-red-500":"";let d;e[20]!==f||e[21]!==L?(d=t.jsx(H,{id:"username",placeholder:"Enter your username",...f,className:L}),e[20]=f,e[21]=L,e[22]=d):d=e[22];let x;e[23]!==w.username?(x=w.username&&t.jsx("p",{className:"text-sm text-red-500",children:w.username.message}),e[23]=w.username,e[24]=x):x=e[24];let p;e[25]!==r?(p=r?.username?t.jsxs("p",{className:"text-muted-foreground text-xs",children:["Username can only be changed once per month.",r?.updated_at&&t.jsxs(t.Fragment,{children:[" ","Last changed on"," ",new Date(r.updated_at).toLocaleDateString(),"."]})]}):t.jsx("p",{className:"text-destructive text-xs",children:"A username is required in order to create Entropretty entries."}),e[25]=r,e[26]=p):p=e[26];let h;e[27]!==d||e[28]!==x||e[29]!==p?(h=t.jsxs("div",{className:"flex flex-col gap-2",children:[N,d,x,p]}),e[27]=d,e[28]=x,e[29]=p,e[30]=h):h=e[30];const P=!k||y.isPending,C=y.isPending?"Saving...":"Save Changes";let g;e[31]!==P||e[32]!==C?(g=t.jsx(Z,{type:"submit",disabled:P,className:"w-fit",children:C}),e[31]=P,e[32]=C,e[33]=g):g=e[33];let _;return e[34]!==h||e[35]!==g||e[36]!==u?(_=t.jsxs("form",{onSubmit:u,className:"flex w-full flex-col gap-4",children:[h,g]}),e[34]=h,e[35]=g,e[36]=u,e[37]=_):_=e[37],_}function X(s){R.error(s.message)}function Y(){const s=D.c(4),{user:e}=I(),r=Q(),{data:a,isLoading:j}=G();if(!e)return r("/login"),null;if(j){let o;return s[0]===Symbol.for("react.memo_cache_sentinel")?(o=t.jsx("div",{className:"flex h-full w-full flex-col items-start gap-4 overflow-y-scroll p-4",children:t.jsx("div",{children:t.jsx("h3",{className:"text-md font-medium",children:"Loading..."})})}),s[0]=o):o=s[0],o}let n;s[1]===Symbol.for("react.memo_cache_sentinel")?(n=t.jsxs("div",{children:[t.jsx("h3",{className:"text-md font-medium",children:"Profile"}),t.jsx("p",{className:"text-muted-foreground text-xs",children:"This is how others will see you on the site."})]}),s[1]=n):n=s[1];const i=a||null;let l;return s[2]!==i?(l=t.jsxs("div",{className:"flex h-full w-full flex-col items-start gap-4 overflow-y-scroll p-4",children:[n,t.jsx(W,{profile:i})]}),s[2]=i,s[3]=l):l=s[3],l}function ee(){const s=D.c(1);let e;return s[0]===Symbol.for("react.memo_cache_sentinel")?(e=t.jsx("div",{className:"flex w-full max-w-4xl flex-col gap-4 p-4",children:t.jsx(Y,{})}),s[0]=e):e=s[0],e}const ue=ee;export{ue as component};
